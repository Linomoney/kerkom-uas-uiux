<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin - Barokah Umroh</title>
    
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="../css/output.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        scroll-behavior: smooth;
        color: #1a1a1a;
      }

      .font-arabic {
        font-family: "Amiri", serif;
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.8s ease-out;
      }

      /* Custom Colors */
      .bg-gradient-green {
        background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
      }

      .bg-gradient-gold {
        background: linear-gradient(135deg, #d4af37 0%, #f4e5a1 100%);
      }

      .text-gradient-green {
        background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* Islamic Pattern Background */
      .islamic-pattern {
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232E7D32' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
      }

      /* Card Hover */
      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(46, 125, 50, 0.15);
      }

      /* Sidebar Styles */
      .sidebar-width {
        width: 260px;
      }

      @media (max-width: 768px) {
        .sidebar-width {
          width: 100%;
        }
      }

      /* Notification Badge */
      .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        min-width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0 6px;
      }

      /* Modal Styles */
      .modal-overlay {
        background-color: rgba(0, 0, 0, 0.5);
      }

      /* Table Styles */
      .table-container {
        overflow-x: auto;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        background: white;
      }

      /* Package Card Gradients */
      .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .gradient-success {
        background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
      }

      .gradient-warning {
        background: linear-gradient(135deg, #d4af37 0%, #f4e5a1 100%);
      }

      .gradient-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }

      .gradient-info {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      }
    </style>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'green-primary': '#2e7d32',
              'green-secondary': '#43a047',
              'gold-primary': '#d4af37',
              'gold-secondary': '#f4e5a1',
            },
            fontFamily: {
              'poppins': ['Poppins', 'sans-serif'],
              'amiri': ['Amiri', 'serif'],
            },
          }
        }
      }
    </script>
  </head>
  
  <body class="bg-gray-50 font-poppins">
    <!-- Main Container -->
    <div class="flex h-screen">
      <!-- Sidebar (Hidden on mobile) -->
      <div class="hidden md:flex flex-col sidebar-width bg-gradient-to-b from-green-900 to-green-800 text-white">
        <!-- Logo -->
        <div class="p-6 border-b border-green-700">
          <div class="flex items-center space-x-3">
            <div class="text-3xl text-green-300">
              <i class="fas fa-kaaba"></i>
            </div>
            <div>
              <h1 class="text-xl font-bold">Barokah Umroh</h1>
              <p class="text-sm text-green-300">Admin Panel</p>
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4 space-y-2">
          <a href="javascript:void(0);" onclick="showSection('dashboard')" class="flex items-center space-x-3 p-3 rounded-lg bg-green-700 text-white">
            <i class="fas fa-home w-6 text-center"></i>
            <span>Dashboard</span>
          </a>
          
          <a href="javascript:void(0);" onclick="showSection('messages')" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-green-800 transition duration-200 text-white relative">
            <i class="fas fa-envelope w-6 text-center"></i>
            <span>Pesan Masuk</span>
            <span class="notification-badge" id="messageBadge">0</span>
          </a>
          
          <a href="javascript:void(0);" onclick="showSection('jamaah')" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-green-800 transition duration-200 text-white">
            <i class="fas fa-users w-6 text-center"></i>
            <span>Data Jamaah</span>
          </a>
          
          <a href="javascript:void(0);" onclick="showSection('packages')" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-green-800 transition duration-200 text-white">
            <i class="fas fa-box w-6 text-center"></i>
            <span>Kelola Paket</span>
          </a>
          
          <a href="javascript:void(0);" onclick="showSection('reports')" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-green-800 transition duration-200 text-white">
            <i class="fas fa-chart-line w-6 text-center"></i>
            <span>Laporan</span>
          </a>
        </nav>

        <!-- User Info -->
        <div class="p-4 border-t border-green-700">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-gradient-green rounded-full flex items-center justify-center">
              <i class="fas fa-user text-white"></i>
            </div>
            <div class="flex-1">
              <p class="font-semibold" id="adminName">Admin</p>
              <p class="text-xs text-green-300">Administrator</p>
            </div>
            <button onclick="logout()" class="text-green-300 hover:text-white transition">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Bar -->
        <header class="bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <!-- Mobile Menu Button -->
            <button id="mobileMenuBtn" class="md:hidden text-gray-700 focus:outline-none">
              <i class="fas fa-bars text-xl"></i>
            </button>

            <!-- Page Title -->
            <div>
              <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Dashboard</h1>
              <nav class="flex space-x-2 text-sm text-gray-600">
                <a href="javascript:void(0);" onclick="showSection('dashboard')" class="hover:text-green-700">Home</a>
                <span>/</span>
                <span id="breadcrumbActive">Dashboard</span>
              </nav>
            </div>

            <!-- Notifications and User -->
            <div class="flex items-center space-x-4">
              <!-- Notifications -->
              <div class="relative">
                <button onclick="toggleNotifications()" class="relative text-gray-600 hover:text-green-700 transition">
                  <i class="fas fa-bell text-xl"></i>
                  <span class="notification-badge" id="topNotifBadge">0</span>
                </button>
                
                <!-- Notifications Dropdown -->
                <div id="notificationsDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                  <div class="p-4 border-b border-gray-200">
                    <h3 class="font-bold text-gray-800">Notifikasi</h3>
                    <p class="text-sm text-gray-600" id="notificationCount">0 pesan baru</p>
                  </div>
                  <div class="p-2">
                    <a href="javascript:void(0);" onclick="showSection('messages')" class="flex items-center p-3 hover:bg-gray-50 rounded-lg transition">
                      <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-envelope text-green-600"></i>
                      </div>
                      <div>
                        <p class="font-medium text-gray-800">Pesan Baru</p>
                        <p class="text-sm text-gray-600">Ada <span id="unreadCount">0</span> pesan belum dibaca</p>
                      </div>
                    </a>
                  </div>
                  <div class="border-t border-gray-200 p-2">
                    <a href="javascript:void(0);" onclick="showSection('messages')" class="block text-center text-green-700 hover:text-green-800 p-2">
                      Lihat Semua Pesan
                    </a>
                  </div>
                </div>
              </div>

              <!-- User Profile -->
              <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-green rounded-full flex items-center justify-center text-white font-bold">
                  <span id="adminInitial">A</span>
                </div>
                <div class="hidden md:block">
                  <p class="font-semibold text-gray-800" id="adminNameTop">Admin</p>
                  <p class="text-sm text-gray-600">Administrator</p>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-6 islamic-pattern">
          <!-- Dashboard Section -->
          <div id="dashboard-section" class="space-y-6">
            <!-- Welcome Card -->
            <div class="bg-white rounded-2xl shadow-lg p-6 card-hover animate-fade-in">
              <div class="flex flex-col md:flex-row md:items-center justify-between">
                <div>
                  <h2 class="text-2xl font-bold text-gray-800 mb-2">Selamat datang kembali, <span id="welcomeName" class="text-green-700">Admin</span>!</h2>
                  <p class="text-gray-600">Ini adalah panel admin untuk mengelola data jamaah dan paket umroh.</p>
                </div>
                <div class="mt-4 md:mt-0">
                  <div class="inline-flex items-center px-4 py-2 bg-green-50 text-green-700 rounded-full">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    <span id="currentDate"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <!-- Total Messages -->
              <div class="bg-white rounded-2xl shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Total Pesan</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="totalMessages">0</h3>
                    <p class="text-xs text-green-600 mt-1">
                      <i class="fas fa-arrow-up mr-1"></i>
                      <span>Bulan ini</span>
                    </p>
                  </div>
                  <div class="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-envelope text-blue-600 text-2xl"></i>
                  </div>
                </div>
              </div>

              <!-- Total Jamaah -->
              <div class="bg-white rounded-2xl shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Total Jamaah</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="totalJamaah">0</h3>
                    <p class="text-xs text-green-600 mt-1">
                      <i class="fas fa-arrow-up mr-1"></i>
                      <span>Terdaftar</span>
                    </p>
                  </div>
                  <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-users text-green-600 text-2xl"></i>
                  </div>
                </div>
              </div>

              <!-- Jamaah Aktif -->
              <div class="bg-white rounded-2xl shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Jamaah Aktif</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="activeJamaah">0</h3>
                    <p class="text-xs text-green-600 mt-1">
                      <i class="fas fa-check mr-1"></i>
                      <span>Berangkat</span>
                    </p>
                  </div>
                  <div class="w-14 h-14 bg-purple-100 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-plane-departure text-purple-600 text-2xl"></i>
                  </div>
                </div>
              </div>

              <!-- Total Packages -->
              <div class="bg-white rounded-2xl shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Total Paket</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="totalPackages">0</h3>
                    <p class="text-xs text-green-600 mt-1">
                      <i class="fas fa-box mr-1"></i>
                      <span>Tersedia</span>
                    </p>
                  </div>
                  <div class="w-14 h-14 bg-yellow-100 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-gift text-yellow-600 text-2xl"></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Jamaah Per Bulan Chart -->
              <div class="bg-white rounded-2xl shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between mb-6">
                  <h3 class="text-xl font-bold text-gray-800">Jamaah Per Bulan</h3>
                  <select id="chartYear" class="border border-gray-300 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updateCharts()">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                  </select>
                </div>
                <div class="h-64">
                  <canvas id="jamaahChart"></canvas>
                </div>
              </div>

              <!-- Status Jamaah Chart -->
              <div class="bg-white rounded-2xl shadow-lg p-6 card-hover">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Status Jamaah</h3>
                <div class="h-64">
                  <canvas id="statusChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Messages Section -->
          <div id="messages-section" class="hidden space-y-6">
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
              <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col md:flex-row md:items-center justify-between">
                  <h3 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">Pesan Masuk</h3>
                  <div class="flex space-x-3">
                    <button onclick="exportMessages()" class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                      <i class="fas fa-download mr-2"></i>
                      Export JSON
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="p-6">
                <!-- Search Bar -->
                <div class="mb-6">
                  <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchMessages" placeholder="Cari pesan..." onkeyup="renderMessages()" 
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                  </div>
                </div>

                <!-- Messages Table -->
                <div class="table-container">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                      <tr class="bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telepon</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paket</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="messagesTableBody" class="bg-white divide-y divide-gray-200">
                      <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Jamaah Section -->
          <div id="jamaah-section" class="hidden space-y-6">
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
              <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col md:flex-row md:items-center justify-between">
                  <h3 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">Data Jamaah</h3>
                  <div class="flex space-x-3">
                    <button onclick="openJamaahModal()" class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                      <i class="fas fa-plus mr-2"></i>
                      Tambah Jamaah
                    </button>
                    <button onclick="exportJamaah()" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                      <i class="fas fa-download mr-2"></i>
                      Export JSON
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="p-6">
                <!-- Search Bar -->
                <div class="mb-6">
                  <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchJamaah" placeholder="Cari jamaah..." onkeyup="renderJamaah()" 
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                  </div>
                </div>

                <!-- Jamaah Table -->
                <div class="table-container">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                      <tr class="bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIK</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telepon</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paket</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Daftar</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="jamaahTableBody" class="bg-white divide-y divide-gray-200">
                      <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Packages Section -->
          <div id="packages-section" class="hidden space-y-6">
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
              <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col md:flex-row md:items-center justify-between">
                  <h3 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">Kelola Paket</h3>
                  <button onclick="openPackageModal()" class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                    <i class="fas fa-plus mr-2"></i>
                    Tambah Paket
                  </button>
                </div>
              </div>
              
              <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="packagesGrid">
                  <!-- Packages akan diisi oleh JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <!-- Reports Section -->
          <div id="reports-section" class="hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Monthly Report -->
              <div class="bg-white rounded-2xl shadow-lg p-6 card-hover">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Laporan Bulanan</h3>
                <div class="space-y-4">
                  <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                      <p class="text-gray-600">Total Pesan Bulan Ini</p>
                    </div>
                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold" id="reportMessages">0</span>
                  </div>
                  <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                      <p class="text-gray-600">Jamaah Terdaftar Bulan Ini</p>
                    </div>
                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold" id="reportJamaah">0</span>
                  </div>
                  <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                      <p class="text-gray-600">Jamaah Berangkat Bulan Ini</p>
                    </div>
                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold" id="reportBerangkat">0</span>
                  </div>
                </div>
              </div>

              <!-- Popular Packages -->
              <div class="bg-white rounded-2xl shadow-lg p-6 card-hover">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Paket Terpopuler</h3>
                <div id="popularPackages" class="space-y-4">
                  <!-- Will be populated by JS -->
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="mobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <!-- Mobile Sidebar -->
    <div id="mobileSidebar" class="fixed inset-y-0 left-0 sidebar-width bg-gradient-to-b from-green-900 to-green-800 text-white transform -translate-x-full transition-transform duration-300 z-50">
      <div class="p-6 border-b border-green-700">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="text-3xl text-green-300">
              <i class="fas fa-kaaba"></i>
            </div>
            <div>
              <h1 class="text-xl font-bold">Barokah Umroh</h1>
              <p class="text-sm text-green-300">Admin Panel</p>
            </div>
          </div>
          <button onclick="closeMobileMenu()" class="text-green-300 hover:text-white">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>

      <nav class="p-4 space-y-2">
        <a href="javascript:void(0);" onclick="showSection('dashboard'); closeMobileMenu()" class="flex items-center space-x-3 p-3 rounded-lg bg-green-700 text-white">
          <i class="fas fa-home w-6 text-center"></i>
          <span>Dashboard</span>
        </a>
        
        <a href="javascript:void(0);" onclick="showSection('messages'); closeMobileMenu()" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-green-800 transition duration-200 text-white relative">
          <i class="fas fa-envelope w-6 text-center"></i>
          <span>Pesan Masuk</span>
          <span class="notification-badge" id="mobileMessageBadge">0</span>
        </a>
        
        <a href="javascript:void(0);" onclick="showSection('jamaah'); closeMobileMenu()" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-green-800 transition duration-200 text-white">
          <i class="fas fa-users w-6 text-center"></i>
          <span>Data Jamaah</span>
        </a>
        
        <a href="javascript:void(0);" onclick="showSection('packages'); closeMobileMenu()" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-green-800 transition duration-200 text-white">
          <i class="fas fa-box w-6 text-center"></i>
          <span>Kelola Paket</span>
        </a>
        
        <a href="javascript:void(0);" onclick="showSection('reports'); closeMobileMenu()" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-green-800 transition duration-200 text-white">
          <i class="fas fa-chart-line w-6 text-center"></i>
          <span>Laporan</span>
        </a>
      </nav>

      <div class="p-4 border-t border-green-700 mt-auto">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-green rounded-full flex items-center justify-center">
            <i class="fas fa-user text-white"></i>
          </div>
          <div class="flex-1">
            <p class="font-semibold" id="mobileAdminName">Admin</p>
            <p class="text-xs text-green-300">Administrator</p>
          </div>
          <button onclick="logout()" class="text-green-300 hover:text-white transition">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Message Detail Modal -->
    <div id="messageModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="modal-overlay absolute inset-0"></div>
      <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
          <div class="bg-gradient-green text-white p-6">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold">Detail Pesan</h3>
              <button onclick="closeMessageModal()" class="text-white hover:text-gray-200">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
          </div>
          <div class="p-6 overflow-y-auto" id="messageDetail">
            <!-- Content akan diisi oleh JavaScript -->
          </div>
          <div class="border-t border-gray-200 p-6">
            <button onclick="closeMessageModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
              Tutup
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Jamaah Form Modal -->
    <div id="jamaahModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="modal-overlay absolute inset-0"></div>
      <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
          <div class="bg-gradient-green text-white p-6">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold" id="jamaahModalTitle">Tambah Jamaah Baru</h3>
              <button onclick="closeJamaahModal()" class="text-white hover:text-gray-200">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
          </div>
          
          <form id="jamaahForm" onsubmit="saveJamaah(event)" class="p-6 overflow-y-auto">
            <input type="hidden" id="jamaahId" />
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                <input type="text" id="jamaahNama" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">NIK *</label>
                <input type="text" id="jamaahNIK" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" maxlength="16" required />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tempat Lahir *</label>
                <input type="text" id="jamaahTempatLahir" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Lahir *</label>
                <input type="date" id="jamaahTanggalLahir" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Kelamin *</label>
                <select id="jamaahJenisKelamin" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                  <option value="">Pilih...</option>
                  <option value="Laki-laki">Laki-laki</option>
                  <option value="Perempuan">Perempuan</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon *</label>
                <input type="tel" id="jamaahTelepon" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" id="jamaahEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">No. Paspor</label>
                <input type="text" id="jamaahPaspor" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Paket Umroh *</label>
                <select id="jamaahPaket" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                  <option value="">Pilih Paket...</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                <select id="jamaahStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                  <option value="Terdaftar">Terdaftar</option>
                  <option value="Proses">Proses</option>
                  <option value="Siap Berangkat">Siap Berangkat</option>
                  <option value="Berangkat">Berangkat</option>
                  <option value="Selesai">Selesai</option>
                </select>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">Alamat Lengkap *</label>
              <textarea id="jamaahAlamat" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required></textarea>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
              <textarea id="jamaahCatatan" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
            </div>

            <div class="flex justify-end space-x-3">
              <button type="button" onclick="closeJamaahModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
                Batal
              </button>
              <button type="submit" class="flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                <i class="fas fa-save mr-2"></i>
                Simpan
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Package Form Modal -->
    <div id="packageModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="modal-overlay absolute inset-0"></div>
      <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
          <div class="bg-gradient-green text-white p-6">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold" id="packageModalTitle">Tambah Paket Baru</h3>
              <button onclick="closePackageModal()" class="text-white hover:text-gray-200">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
          </div>
          
          <form id="packageForm" onsubmit="savePackage(event)" class="p-6 overflow-y-auto">
            <input type="hidden" id="packageId" />
            
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">Nama Paket *</label>
              <input type="text" id="packageNama" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Contoh: Paket Silver" required />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Durasi *</label>
                <input type="text" id="packageDurasi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Contoh: 9 Hari" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Harga (Rp) *</label>
                <input type="number" id="packageHarga" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="25000000" required />
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">Icon *</label>
              <select id="packageIcon" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                <option value="">Pilih Icon...</option>
                <option value="moon">üåô Moon (Bulan)</option>
                <option value="star">‚≠ê Star (Bintang)</option>
                <option value="crown">üëë Crown (Mahkota)</option>
                <option value="gem">üíé Gem (Permata)</option>
                <option value="trophy">üèÜ Trophy (Trofi)</option>
                <option value="gift">üéÅ Gift (Hadiah)</option>
              </select>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">Fasilitas * (pisahkan dengan enter)</label>
              <textarea id="packageFasilitas" rows="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                placeholder="Tiket pesawat PP
Hotel bintang 3
Makan 3x sehari
Bus wisata AC
Pembimbing berpengalaman
Perlengkapan umroh" required></textarea>
              <p class="text-sm text-gray-500 mt-1">Tulis satu fasilitas per baris</p>
            </div>

            <div class="mb-6">
              <div class="flex items-center">
                <input type="checkbox" id="packageFeatured" class="w-5 h-5 text-green-600 rounded focus:ring-green-500" />
                <label class="ml-2 text-sm text-gray-700">Tandai sebagai Paket Terpopuler</label>
              </div>
            </div>

            <div class="flex justify-end space-x-3">
              <button type="button" onclick="closePackageModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
                Batal
              </button>
              <button type="submit" class="flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                <i class="fas fa-save mr-2"></i>
                Simpan
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // ===== STORAGE KEYS =====
      const STORAGE_KEYS = {
        PACKAGES: "umrohPackages",
        MESSAGES: "umrohMessages",
        JAMAAH: "umrohJamaah",
        USER: "currentUser",
      };

      // ===== GLOBAL DATA =====
      let messages = [];
      let jamaahData = [];
      let packages = [];
      let currentUser = null;
      let jamaahChartInstance = null;
      let statusChartInstance = null;

      // ===== FUNGSI UTAMA =====
      function showSection(sectionName) {
        // Update active menu
        const menuItems = document.querySelectorAll('#mobileSidebar nav a, .flex-col nav a');
        menuItems.forEach(item => {
          item.classList.remove('bg-green-700');
          if (item.onclick && item.onclick.toString().includes(sectionName)) {
            item.classList.add('bg-green-700');
          }
        });

        // Hide all sections
        document.querySelectorAll('main > div').forEach(section => {
          section.classList.add('hidden');
        });

        // Show selected section
        const targetSection = document.getElementById(`${sectionName}-section`);
        if (targetSection) {
          targetSection.classList.remove('hidden');
        }

        // Update page title and breadcrumb
        const titles = {
          dashboard: "Dashboard",
          messages: "Pesan Masuk",
          jamaah: "Data Jamaah",
          packages: "Kelola Paket",
          reports: "Laporan",
        };

        document.getElementById('pageTitle').textContent = titles[sectionName];
        document.getElementById('breadcrumbActive').textContent = titles[sectionName];

        // Load section-specific data
        switch (sectionName) {
          case "messages":
            renderMessages();
            break;
          case "jamaah":
            renderJamaah();
            break;
          case "packages":
            renderPackages();
            break;
          case "reports":
            updateReports();
            break;
          case "dashboard":
            updateDashboard();
            break;
        }
      }

      // ===== FUNGSI AUTH =====
      function checkAuth() {
        const storedUser = localStorage.getItem(STORAGE_KEYS.USER);
        if (!storedUser) {
          window.location.href = "login.html";
          return;
        }
        currentUser = JSON.parse(storedUser);
        const adminName = currentUser.name || "Admin";
        const adminInitial = adminName.charAt(0).toUpperCase();
        
        // Update all admin name displays
        document.querySelectorAll('#adminName, #adminNameTop, #mobileAdminName, #welcomeName').forEach(el => {
          el.textContent = adminName;
        });
        document.getElementById('adminInitial').textContent = adminInitial;
      }

      function logout() {
        if (confirm("Apakah Anda yakin ingin keluar?")) {
          localStorage.removeItem(STORAGE_KEYS.USER);
          window.location.href = "login.html";
        }
      }

      // ===== FUNGSI DATA =====
      function loadData() {
        messages = JSON.parse(localStorage.getItem(STORAGE_KEYS.MESSAGES) || "[]");
        jamaahData = JSON.parse(localStorage.getItem(STORAGE_KEYS.JAMAAH) || "[]");
        packages = JSON.parse(localStorage.getItem(STORAGE_KEYS.PACKAGES) || "[]");
      }

      function updateDashboard() {
        loadData();
        
        document.getElementById('totalMessages').textContent = messages.length;
        document.getElementById('totalJamaah').textContent = jamaahData.length;
        document.getElementById('activeJamaah').textContent = jamaahData.filter((j) => j.status === "Berangkat").length;
        document.getElementById('totalPackages').textContent = packages.length;

        const unreadCount = messages.filter((m) => m.status === "Belum dibaca").length;
        document.getElementById('messageBadge').textContent = unreadCount;
        document.getElementById('mobileMessageBadge').textContent = unreadCount;
        document.getElementById('topNotifBadge').textContent = unreadCount;
        document.getElementById('notificationCount').textContent = `${unreadCount} pesan baru`;
        document.getElementById('unreadCount').textContent = unreadCount;

        // Update current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);

        // Update charts
        updateCharts();
      }

      function updateReports() {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        const messagesThisMonth = messages.filter((m) => {
          if (!m.tanggal) return false;
          const dateStr = m.tanggal.toString();
          const month = currentMonth + 1;
          return dateStr.includes(`${month}/`) || dateStr.includes(`${month}-`) || 
                 dateStr.includes(`${currentYear}`);
        }).length;

        const jamaahThisMonth = jamaahData.filter((j) => {
          if (!j.tanggalDaftar) return false;
          const dateStr = j.tanggalDaftar.toString();
          const month = currentMonth + 1;
          return dateStr.includes(`${month}/`) || dateStr.includes(`${month}-`) || 
                 dateStr.includes(`${currentYear}`);
        }).length;

        const berangkatThisMonth = jamaahData.filter((j) => {
          if (j.status !== "Berangkat") return false;
          if (!j.tanggalDaftar) return false;
          const dateStr = j.tanggalDaftar.toString();
          const month = currentMonth + 1;
          return dateStr.includes(`${month}/`) || dateStr.includes(`${month}-`) || 
                 dateStr.includes(`${currentYear}`);
        }).length;

        // Update UI
        document.getElementById('reportMessages').textContent = messagesThisMonth;
        document.getElementById('reportJamaah').textContent = jamaahThisMonth;
        document.getElementById('reportBerangkat').textContent = berangkatThisMonth;

        // Update popular packages
        const packageCount = {};
        jamaahData.forEach((j) => {
          if (j.paket) {
            packageCount[j.paket] = (packageCount[j.paket] || 0) + 1;
          }
        });

        const sorted = Object.entries(packageCount)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        const popularDiv = document.getElementById('popularPackages');

        if (sorted.length === 0) {
          popularDiv.innerHTML = '<p class="text-gray-500 text-center">Belum ada data</p>';
        } else {
          popularDiv.innerHTML = sorted.map(([name, count]) => `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
              <span class="font-medium text-gray-800">${name}</span>
              <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">${count} jamaah</span>
            </div>
          `).join('');
        }
      }

      // ===== FUNGSI MESSAGES =====
      function renderMessages() {
        const tbody = document.getElementById('messagesTableBody');
        const searchTerm = document.getElementById('searchMessages').value.toLowerCase() || '';

        let filteredMessages = messages;
        if (searchTerm) {
          filteredMessages = messages.filter((m) => 
            m.nama.toLowerCase().includes(searchTerm) || 
            m.email.toLowerCase().includes(searchTerm) || 
            m.pesan.toLowerCase().includes(searchTerm)
          );
        }

        if (filteredMessages.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i>
                <p>Tidak ada pesan</p>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = filteredMessages.map(msg => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
              <div class="flex items-center">
                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(msg.nama)}&background=2E7D32&color=fff&size=40" 
                     class="rounded-full w-10 h-10 mr-3">
                <span class="font-medium text-gray-900">${msg.nama}</span>
              </div>
            </td>
            <td class="px-6 py-4 text-gray-900">${msg.email}</td>
            <td class="px-6 py-4 text-gray-900">${msg.telepon}</td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">${msg.paket}</span>
            </td>
            <td class="px-6 py-4 text-gray-900">${msg.tanggal}</td>
            <td class="px-6 py-4">
              <div class="flex space-x-2">
                <button onclick="viewMessage(${msg.id})" class="text-blue-600 hover:text-blue-800">
                  <i class="fas fa-eye"></i>
                </button>
                <button onclick="deleteMessage(${msg.id})" class="text-red-600 hover:text-red-800">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      function viewMessage(id) {
        const message = messages.find((m) => m.id === id);
        if (message) {
          message.status = "Dibaca";
          localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(messages));
          updateDashboard();

          document.getElementById('messageDetail').innerHTML = `
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">Nama:</label>
                  <p class="mt-1 text-gray-900">${message.nama}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">Email:</label>
                  <p class="mt-1 text-gray-900">${message.email}</p>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">Telepon:</label>
                  <p class="mt-1 text-gray-900">${message.telepon}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">Paket:</label>
                  <p class="mt-1 text-gray-900">${message.paket}</p>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Tanggal:</label>
                <p class="mt-1 text-gray-900">${message.tanggal}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Pesan:</label>
                <div class="mt-1 p-4 bg-gray-50 rounded-lg">
                  <p class="text-gray-900">${message.pesan}</p>
                </div>
              </div>
            </div>
          `;
          
          document.getElementById('messageModal').classList.remove('hidden');
        }
      }

      function closeMessageModal() {
        document.getElementById('messageModal').classList.add('hidden');
      }

      function deleteMessage(id) {
        if (confirm("Apakah Anda yakin ingin menghapus pesan ini?")) {
          messages = messages.filter((m) => m.id !== id);
          localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(messages));
          renderMessages();
          updateDashboard();
          alert("Pesan berhasil dihapus");
        }
      }

      function exportMessages() {
        if (messages.length === 0) {
          alert("Tidak ada data untuk di-export");
          return;
        }

        const dataStr = JSON.stringify(messages, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `pesan_${new Date().getTime()}.json`;
        link.click();
        URL.revokeObjectURL(url);
      }

      // ===== FUNGSI JAMAAH =====
      function renderJamaah() {
        const tbody = document.getElementById('jamaahTableBody');
        const searchTerm = document.getElementById('searchJamaah').value.toLowerCase() || '';

        let filteredJamaah = jamaahData;
        if (searchTerm) {
          filteredJamaah = jamaahData.filter((j) => 
            j.nama.toLowerCase().includes(searchTerm) || 
            j.nik.includes(searchTerm) || 
            j.telepon.includes(searchTerm)
          );
        }

        if (filteredJamaah.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                <i class="fas fa-users text-4xl mb-3 text-gray-300"></i>
                <p>Tidak ada data jamaah</p>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = filteredJamaah.map(j => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
              <div class="flex items-center">
                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(j.nama)}&background=2E7D32&color=fff&size=40" 
                     class="rounded-full w-10 h-10 mr-3">
                <div>
                  <p class="font-medium text-gray-900">${j.nama}</p>
                  <p class="text-sm text-gray-500">${j.jenisKelamin}</p>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 text-gray-900">${j.nik}</td>
            <td class="px-6 py-4 text-gray-900">${j.telepon}</td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">${j.paket}</span>
            </td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 ${getStatusClass(j.status)} rounded-full text-sm">${j.status}</span>
            </td>
            <td class="px-6 py-4 text-gray-900">${j.tanggalDaftar}</td>
            <td class="px-6 py-4">
              <div class="flex space-x-2">
                <button onclick="editJamaah(${j.id})" class="text-yellow-600 hover:text-yellow-800">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteJamaah(${j.id})" class="text-red-600 hover:text-red-800">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      function getStatusClass(status) {
        const classes = {
          Terdaftar: "bg-gray-100 text-gray-800",
          Proses: "bg-yellow-100 text-yellow-800",
          "Siap Berangkat": "bg-blue-100 text-blue-800",
          Berangkat: "bg-purple-100 text-purple-800",
          Selesai: "bg-green-100 text-green-800",
        };
        return classes[status] || "bg-gray-100 text-gray-800";
      }

      function openJamaahModal(id = null) {
        // Load package options
        const paketSelect = document.getElementById('jamaahPaket');
        paketSelect.innerHTML = '<option value="">Pilih Paket...</option>' + 
          packages.map(p => `<option value="${p.nama}">${p.nama} - ${p.durasi}</option>`).join('');

        if (id) {
          const jamaah = jamaahData.find((j) => j.id === id);
          if (jamaah) {
            document.getElementById('jamaahModalTitle').textContent = "Edit Data Jamaah";
            document.getElementById('jamaahId').value = jamaah.id;
            document.getElementById('jamaahNama').value = jamaah.nama;
            document.getElementById('jamaahNIK').value = jamaah.nik;
            document.getElementById('jamaahTempatLahir').value = jamaah.tempatLahir;
            document.getElementById('jamaahTanggalLahir').value = jamaah.tanggalLahir;
            document.getElementById('jamaahJenisKelamin').value = jamaah.jenisKelamin;
            document.getElementById('jamaahTelepon').value = jamaah.telepon;
            document.getElementById('jamaahEmail').value = jamaah.email;
            document.getElementById('jamaahPaspor').value = jamaah.paspor || "";
            document.getElementById('jamaahPaket').value = jamaah.paket;
            document.getElementById('jamaahStatus').value = jamaah.status;
            document.getElementById('jamaahAlamat').value = jamaah.alamat;
            document.getElementById('jamaahCatatan').value = jamaah.catatan || "";
          }
        } else {
          document.getElementById('jamaahModalTitle').textContent = "Tambah Jamaah Baru";
          document.getElementById('jamaahForm').reset();
          document.getElementById('jamaahId').value = "";
        }
        document.getElementById('jamaahModal').classList.remove('hidden');
      }

      function closeJamaahModal() {
        document.getElementById('jamaahModal').classList.add('hidden');
      }

      function editJamaah(id) {
        openJamaahModal(id);
      }

      function saveJamaah(event) {
        event.preventDefault();

        const id = document.getElementById('jamaahId').value;
        const now = new Date();

        const tanggalDaftar = now.toLocaleString('id-ID', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        const jamaahObj = {
          id: id ? parseInt(id) : Date.now(),
          nama: document.getElementById('jamaahNama').value,
          nik: document.getElementById('jamaahNIK').value,
          tempatLahir: document.getElementById('jamaahTempatLahir').value,
          tanggalLahir: document.getElementById('jamaahTanggalLahir').value,
          jenisKelamin: document.getElementById('jamaahJenisKelamin').value,
          telepon: document.getElementById('jamaahTelepon').value,
          email: document.getElementById('jamaahEmail').value,
          paspor: document.getElementById('jamaahPaspor').value,
          paket: document.getElementById('jamaahPaket').value,
          status: document.getElementById('jamaahStatus').value,
          alamat: document.getElementById('jamaahAlamat').value,
          catatan: document.getElementById('jamaahCatatan').value,
          tanggalDaftar: id ? jamaahData.find(j => j.id === parseInt(id)).tanggalDaftar : tanggalDaftar,
          tanggalDaftarISO: now.toISOString()
        };

        if (id) {
          const index = jamaahData.findIndex((j) => j.id === parseInt(id));
          jamaahData[index] = jamaahObj;
        } else {
          jamaahData.push(jamaahObj);
        }

        localStorage.setItem(STORAGE_KEYS.JAMAAH, JSON.stringify(jamaahData));
        renderJamaah();
        updateDashboard();
        closeJamaahModal();
        alert(id ? "Data jamaah berhasil diupdate" : "Jamaah baru berhasil ditambahkan");
      }

      function deleteJamaah(id) {
        if (confirm("Apakah Anda yakin ingin menghapus data jamaah ini?")) {
          jamaahData = jamaahData.filter((j) => j.id !== id);
          localStorage.setItem(STORAGE_KEYS.JAMAAH, JSON.stringify(jamaahData));
          renderJamaah();
          updateDashboard();
          alert("Data jamaah berhasil dihapus");
        }
      }

      function exportJamaah() {
        if (jamaahData.length === 0) {
          alert("Tidak ada data untuk di-export");
          return;
        }

        const dataStr = JSON.stringify(jamaahData, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `jamaah_${new Date().getTime()}.json`;
        link.click();
        URL.revokeObjectURL(url);
      }

      // ===== FUNGSI PACKAGES =====
      function renderPackages() {
        const grid = document.getElementById('packagesGrid');

        if (packages.length === 0) {
          grid.innerHTML = '<div class="col-span-3 text-center text-gray-500"><p>Belum ada paket tersedia</p></div>';
          return;
        }

        grid.innerHTML = packages.map(pkg => `
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-hover ${pkg.featured ? 'border-4 border-yellow-500 relative' : ''}">
            ${pkg.featured ? `
              <div class="absolute top-4 right-4 bg-yellow-500 text-white px-4 py-1 rounded-full text-sm font-bold z-10">
                TERPOPULER
              </div>
            ` : ''}
            <div class="${pkg.gradient} text-white p-6 text-center">
              <i class="fas fa-${pkg.icon} text-4xl mb-3"></i>
              <h3 class="text-2xl font-bold">${pkg.nama}</h3>
              <p class="text-sm opacity-90 mt-2">${pkg.durasi}</p>
            </div>
            <div class="p-6">
              <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 text-center py-3 px-6 rounded-full mb-6">
                <div class="text-sm text-gray-700">Mulai dari</div>
                <div class="text-3xl font-bold text-green-800">Rp ${(pkg.harga / 1000000).toFixed(0)} Juta</div>
              </div>
              <ul class="space-y-3 mb-6">
                ${pkg.fasilitas.slice(0, 3).map(f => `
                  <li class="flex items-start">
                    <i class="fas fa-check-circle text-green-600 mt-1 mr-3"></i>
                    <span class="text-gray-700">${f}</span>
                  </li>
                `).join('')}
                ${pkg.fasilitas.length > 3 ? `
                  <li class="text-gray-500 text-sm">
                    <i class="fas fa-plus mr-2"></i>
                    ${pkg.fasilitas.length - 3} fasilitas lainnya
                  </li>
                ` : ''}
              </ul>
              <div class="flex space-x-2">
                <button onclick="editPackage(${pkg.id})" class="flex-1 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition duration-200">
                  <i class="fas fa-edit mr-2"></i>Edit
                </button>
                <button onclick="deletePackage(${pkg.id})" class="flex-1 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200">
                  <i class="fas fa-trash mr-2"></i>Hapus
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }

      function openPackageModal(id = null) {
        if (id) {
          const pkg = packages.find((p) => p.id === id);
          if (pkg) {
            document.getElementById('packageModalTitle').textContent = "Edit Paket";
            document.getElementById('packageId').value = pkg.id;
            document.getElementById('packageNama').value = pkg.nama;
            document.getElementById('packageDurasi').value = pkg.durasi;
            document.getElementById('packageHarga').value = pkg.harga;
            document.getElementById('packageIcon').value = pkg.icon;
            document.getElementById('packageFasilitas').value = pkg.fasilitas.join('\n');
            document.getElementById('packageFeatured').checked = pkg.featured;
          }
        } else {
          document.getElementById('packageModalTitle').textContent = "Tambah Paket Baru";
          document.getElementById('packageForm').reset();
          document.getElementById('packageId').value = "";
        }
        document.getElementById('packageModal').classList.remove('hidden');
      }

      function closePackageModal() {
        document.getElementById('packageModal').classList.add('hidden');
      }

      function editPackage(id) {
        openPackageModal(id);
      }

      function savePackage(event) {
        event.preventDefault();

        const id = document.getElementById('packageId').value;
        const fasilitas = document.getElementById('packageFasilitas').value
          .split('\n')
          .filter(f => f.trim());

        // Determine gradient
        const gradients = [
          "gradient-success",
          "gradient-warning",
          "gradient-primary",
          "gradient-info",
        ];
        const gradient = gradients[Math.floor(Math.random() * gradients.length)];

        const packageObj = {
          id: id ? parseInt(id) : Date.now(),
          nama: document.getElementById('packageNama').value,
          durasi: document.getElementById('packageDurasi').value,
          harga: parseFloat(document.getElementById('packageHarga').value),
          icon: document.getElementById('packageIcon').value,
          gradient: gradient,
          fasilitas: fasilitas,
          featured: document.getElementById('packageFeatured').checked,
        };

        if (id) {
          const index = packages.findIndex((p) => p.id === parseInt(id));
          packages[index] = packageObj;
        } else {
          packages.push(packageObj);
        }

        localStorage.setItem(STORAGE_KEYS.PACKAGES, JSON.stringify(packages));
        renderPackages();
        updateDashboard();
        closePackageModal();
        alert(id ? "Paket berhasil diupdate" : "Paket baru berhasil ditambahkan");
      }

      function deletePackage(id) {
        if (confirm("Apakah Anda yakin ingin menghapus paket ini?")) {
          packages = packages.filter((p) => p.id !== id);
          localStorage.setItem(STORAGE_KEYS.PACKAGES, JSON.stringify(packages));
          renderPackages();
          updateDashboard();
          alert("Paket berhasil dihapus");
        }
      }

      // ===== FUNGSI CHARTS =====
      function getJamaahPerBulanTahun() {
        const year = parseInt(document.getElementById('chartYear').value);
        const bulanLabels = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
        const dataPerBulan = new Array(12).fill(0);

        jamaahData.forEach((jamaah) => {
          if (jamaah.tanggalDaftar) {
            try {
              const dateStr = jamaah.tanggalDaftar.toString();
              
              // Check if the date contains the selected year
              if (dateStr.includes(year.toString())) {
                let month = -1;

                // Try to parse month from various formats
                if (dateStr.includes("/")) {
                  const parts = dateStr.split(" ")[0].split("/");
                  if (parts.length >= 3 && parts[2].includes(year.toString())) {
                    month = parseInt(parts[1]) - 1;
                  }
                } else if (dateStr.includes("-")) {
                  const parts = dateStr.split("-");
                  if (parts[0].includes(year.toString())) {
                    month = parseInt(parts[1]) - 1;
                  }
                }

                if (month >= 0 && month < 12) {
                  dataPerBulan[month] += 1;
                }
              }
            } catch (error) {
              console.error("Error parsing date:", error);
            }
          }
        });

        return {
          labels: bulanLabels,
          data: dataPerBulan,
        };
      }

      function initCharts() {
        const chartData = getJamaahPerBulanTahun();

        // Jamaah Per Bulan Chart
        const ctx1 = document.getElementById('jamaahChart');
        if (ctx1) {
          if (jamaahChartInstance) {
            jamaahChartInstance.destroy();
          }

          jamaahChartInstance = new Chart(ctx1, {
            type: 'line',
            data: {
              labels: chartData.labels,
              datasets: [{
                label: 'Jumlah Jamaah',
                data: chartData.data,
                borderColor: '#2e7d32',
                backgroundColor: 'rgba(46, 125, 50, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#2e7d32',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Jumlah Jamaah'
                  },
                  ticks: {
                    precision: 0
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Bulan'
                  }
                }
              }
            }
          });
        }

        // Status Jamaah Chart
        const ctx2 = document.getElementById('statusChart');
        if (ctx2) {
          if (statusChartInstance) {
            statusChartInstance.destroy();
          }

          const statusCounts = {
            Terdaftar: jamaahData.filter((j) => j.status === "Terdaftar").length,
            Proses: jamaahData.filter((j) => j.status === "Proses").length,
            "Siap Berangkat": jamaahData.filter((j) => j.status === "Siap Berangkat").length,
            Berangkat: jamaahData.filter((j) => j.status === "Berangkat").length,
            Selesai: jamaahData.filter((j) => j.status === "Selesai").length
          };

          statusChartInstance = new Chart(ctx2, {
            type: 'doughnut',
            data: {
              labels: Object.keys(statusCounts),
              datasets: [{
                data: Object.values(statusCounts),
                backgroundColor: [
                  'rgba(108, 117, 125, 0.8)',
                  'rgba(255, 193, 7, 0.8)',
                  'rgba(23, 162, 184, 0.8)',
                  'rgba(0, 123, 255, 0.8)',
                  'rgba(40, 167, 69, 0.8)'
                ],
                borderColor: [
                  'rgb(108, 117, 125)',
                  'rgb(255, 193, 7)',
                  'rgb(23, 162, 184)',
                  'rgb(0, 123, 255)',
                  'rgb(40, 167, 69)'
                ],
                borderWidth: 2,
                hoverOffset: 15
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'right',
                  labels: {
                    padding: 20,
                    usePointStyle: true,
                    pointStyle: 'circle'
                  }
                }
              }
            }
          });
        }
      }

      function updateCharts() {
        loadData();
        initCharts();
      }

      // ===== MOBILE MENU FUNCTIONS =====
      function openMobileMenu() {
        document.getElementById('mobileSidebar').classList.remove('-translate-x-full');
        document.getElementById('mobileOverlay').classList.remove('hidden');
      }

      function closeMobileMenu() {
        document.getElementById('mobileSidebar').classList.add('-translate-x-full');
        document.getElementById('mobileOverlay').classList.add('hidden');
      }

      function toggleNotifications() {
        const dropdown = document.getElementById('notificationsDropdown');
        dropdown.classList.toggle('hidden');
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', (event) => {
        const dropdown = document.getElementById('notificationsDropdown');
        const button = event.target.closest('button');
        
        if (!button || !button.onclick || button.onclick.toString().indexOf('toggleNotifications') === -1) {
          if (dropdown && !dropdown.contains(event.target)) {
            dropdown.classList.add('hidden');
          }
        }
      });

      // ===== INITIALIZATION =====
      document.addEventListener('DOMContentLoaded', function() {
        // Set current year in chart selector
        const currentYear = new Date().getFullYear();
        document.getElementById('chartYear').value = currentYear;

        // Mobile menu button
        document.getElementById('mobileMenuBtn').addEventListener('click', openMobileMenu);
        
        // Close mobile menu when clicking overlay
        document.getElementById('mobileOverlay').addEventListener('click', closeMobileMenu);

        // Check authentication
        checkAuth();

        // Load data
        loadData();

        // Initialize dashboard
        updateDashboard();

        // Set default section
        showSection('dashboard');
      });
    </script>
  </body>
</html>